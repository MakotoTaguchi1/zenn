---
title: "CronJobä½¿ã„å§‹ã‚ã¦ãƒãƒã£ãŸç®‡æ‰€ã¾ã¨ã‚ã¦ã¿ãŸ"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [k8s, gke, cronjob]
published: false
---

# ã¯ã˜ã‚ã«

æœ€è¿‘æ¥­å‹™ã§K8s CronJobã‚’ä½¿ã£ãŸã‚¸ãƒ§ãƒ–ã‚’æ§‹ç¯‰ã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Š
ã¾ã—ãŸã€‚
ä¸€ã‹ã‚‰æ§‹ç¯‰ã™ã‚‹ã®ã¯åˆã‚ã¦ã ã£ãŸã“ã¨ã‚‚ã‚ã‚Šã€
åˆæ­©çš„ãªã“ã¨ã‹ã‚‰åœ°å‘³ã«è‹¦æˆ¦ã—ãŸã®ã§è¨˜éŒ²ã—ã¦ã¿ã¾ã—ãŸã€‚

---
title: "CronJobä½¿ã„å§‹ã‚ã¦ãƒãƒã£ãŸç®‡æ‰€ã¾ã¨ã‚ã¦ã¿ãŸ"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [k8s, gke, cronjob]
published: false
---

# ã¯ã˜ã‚ã«

æœ€è¿‘æ¥­å‹™ã§K8s CronJobã‚’ä½¿ã£ãŸã‚¸ãƒ§ãƒ–ã‚’æ§‹ç¯‰ã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Š
ã¾ã—ãŸã€‚
ä¸€ã‹ã‚‰æ§‹ç¯‰ã™ã‚‹ã®ã¯åˆã‚ã¦ã ã£ãŸã“ã¨ã‚‚ã‚ã‚Šã€
åœ°å‘³ã«è‹¦æˆ¦ã—ãƒãƒã‚Šã¾ãã£ãŸã®ã§ãã®ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ãŸã€‚

è‡ªåˆ†ã¨åŒã˜ã‚ˆã†ã«CronJobã‚’ã‚ˆãçŸ¥ã‚‰ãªã„/è§¦ã‚Šå§‹ã‚ã®æ–¹ãªã©ã®
ãŠå½¹ã«ç«‹ã¦ã‚Œã°å¹¸ã„ã§ã™ã€‚

# Environment

ç­†è€…ãŒä»Šå›ä½¿ç”¨ã—ãŸç’°å¢ƒã¯ä»¥ä¸‹ã§ã™ã€‚

- GKE Autopilot ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼
- K8s Version: 1.29.7

# ãƒãƒã£ãŸãƒã‚¤ãƒ³ãƒˆ

## schedule ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³

åŸºæœ¬çš„ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ UTC ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã«ãªã‚‹ç’°å¢ƒãŒå¤šã„ã‚ˆã†ã§ã™ã€‚ï¼ˆGKE ã§ã‚‚ãã†ã§ã—ãŸã€‚ï¼‰
ãã®ãŸã‚ã€æ—¥æœ¬æ™‚é–“ã§ã¯ +9 æ™‚é–“ã§ã‚»ãƒƒãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```yaml
spec:
  # ã“ã‚Œã¯,æ—¥æœ¬æ™‚é–“ æ¯æ—¥ 19æ™‚ ã«å®Ÿè¡Œã•ã‚Œã‚‹
  schedule: "0 10 * * *"
  jobTemplate:
    # ...ã‚¸ãƒ§ãƒ–ã®è¨˜è¿°
```

ã—ã‹ã—ãªãŒã‚‰ Ks8 v1.27 ä»¥é™ã§ã¯ã€`.spec.timeZone`ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã€
ãƒ¦ãƒ¼ã‚¶å´ã§ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è‡ªç”±ã«ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```yaml
spec:
  timeZone: "Asia/Tokyo"
  schedule: "0 10 * * *"
  jobTemplate:
    # ...ã‚¸ãƒ§ãƒ–ã®è¨˜è¿°
```

> You can specify a time zone for a CronJob by setting .spec.timeZone to the name of a valid time zone. For example, setting .spec.timeZone: "Etc/UTC" instructs Kubernetes to interpret the schedule relative to Coordinated Universal Time.

https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/#time-zones

## ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ãŸã„ã¨ã

Pod ä¸­ã«è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã‚‹ã‚µã‚¤ãƒ‰ã‚«ãƒ¼æ§‹æˆã«ã—ãŸã„ã¨ããŒã‚ã‚Šã¾ã™ã€‚
è‡ªåˆ†ã‚‚ä»Šå›ã€GKE Pod ã‹ã‚‰ CloudSQL ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‹ã£ãŸã®ã§`cloud-sql-proxy`ã‚’ä½¿ã„ãŸã‹ã£ãŸã§ã™ã€‚

ã“ã®æ™‚ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

deployment ã¨åŒã˜ã‚ˆã†ã«ã€`template.spec.containers`ã«ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã¨ä¸¦åˆ—ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’è¨˜è¿°ã™ã‚‹ã¨ã€
ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¸ãƒ§ãƒ–ãŒçµ‚äº†ï¼ˆCompletedï¼‰ã—ã¦ã‚‚ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒèµ·å‹•ã—ç¶šã‘ã‚‹ï¼ˆRunningï¼‰ãŸã‚ã€æ°¸ä¹…ã« CronJob ãŒçµ‚äº†ã—ãªã„çŠ¶æ³ã«é™¥ã‚Šã¾ã™ã€‚
ï¼ˆè‡ªåˆ†ã‚‚ãƒãƒã‚Šã¾ã—ãŸï¼‰

ãã“ã§ã€K8s v1.29 ã‚ˆã‚Š beta ã«æ˜‡æ ¼ã—ãŸ `SidecarContainers`ã¨ã„ã†æ©Ÿèƒ½ãŒä¾¿åˆ©ã§ã™ã€‚

ã“ã®æ©Ÿèƒ½ã§ã¯ã€
- `initContainers`ã¨ã„ã†ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’æ›¸ãã€
- `restartPolicy: Always`ã¨ã™ã‚‹ã“ã¨ã§

ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠçµ‚äº†å¾Œã‚‚ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yaml

```

https://kubernetes.io/ja/docs/concepts/workloads/pods/sidecar-containers/

## GKE Autopilot ã®ãƒªã‚½ãƒ¼ã‚¹é…ç½®

resource request / limit ã«ã¤ã„ã¦ã§ã™ã€‚
GKE Autopilot ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ Pod ã«ã¤ã„ã¦ request / limit ã®åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚
é…ç½®å¯èƒ½ãªæœ€å°/æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ cpu/memory ã®æ¯”ç‡ã€ãƒãƒ¼ã‚¹ãƒˆå¯å¦ãªã©ã€ã„ãã¤ã‹ã®åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚

è©³ã—ãã¯ã€ä»¥ä¸‹ã”è¦§ãã ã•ã„ã€‚

https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-resource-requests?hl=ja

2024 å¹´ 8 æœˆç¾åœ¨ã€CronJob ã§ã¯ã€ä»¥ä¸‹ã‚’æ°—ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

- request, limit ã¯ä¸¡æ–¹æ˜è¨˜ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚ï¼ˆDeployment ç­‰ã§ã¯çœç•¥ã—ã¦ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã€‚Autopilot å´ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒä»˜ä¸ã•ã‚Œã‚‹ï¼‰
- request = limit å€¤ã¨ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚ï¼ˆãŠãã‚‰ããƒãƒ¼ã‚¹ãƒˆä¸å¯ï¼‰

kubectl diff ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚apply ã‚‚å¤±æ•—ã—ã¾ã™ã€‚

```
# request, limitæ›¸ã‹ãªã„æ™‚
Violations details: {"[denied by autogke-pod-limit-constraints]":["container '<ã‚³ãƒ³ãƒ†ãƒŠå>' does not have resources/limits defined for all resources which is required in Autopilot clusters."]}

# request = limitå€¤ã¨ã—ãªã‹ã£ãŸæ™‚
Violations details: {"[denied by autogke-pod-limit-constraints]":["container '<ã‚³ãƒ³ãƒ†ãƒŠå>' does not have resource==limits which is required in Autopilot clusters."]}
```

ç‰¹ã«ãƒãƒ¼ã‚¹ãƒˆã§ããªã„ã®ã¯å¾®å¦™ã§ã™ãŒã€Autopilot å´ã®æ”¹å–„ã‚’å¾…ã¡ãŸã„ã§ã™ã€‚



## restartPolicy, backoffLimit

GKE ã«é™ã‚‰ãš CronJob ã‚’æ‰±ã†ä¸Šã§æ°—ã‚’ä»˜ã‘ã‚‹ã¹ãç®‡æ‰€ã§ã™ã€‚
å¤±æ•—æ™‚ã®å†å®Ÿè¡Œã«ã¤ã„ã¦ã¯ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŠŠæ¡ã—ã¦æ¤œè¨ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


### restartPolicy

`Never`ã¾ãŸã¯`OnFailure`ãŒæŒ‡å®šã§ãã¾ã™ã€‚

#### Never

- ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã™ã‚‹ã¨ã€ãã® Pod ã¯å†å®Ÿè¡Œã•ã‚Œãªã„ã€‚
- ãŸã ã—ã€**backoffLimit ã«é”ã™ã‚‹ã¾ã§æ–°ã—ã„ Pod ã§ã‚¸ãƒ§ãƒ–ãŒå†å®Ÿè¡Œã•ã‚Œã‚‹ã€‚ï¼ˆèª¤è§£ã—ã‚„ã™ã„ï¼‰**
  - ãã®ãŸã‚ç•°ãªã‚‹ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚‹ã“ã¨ã‚„çŠ¶æ…‹ã¯ä¿æŒã•ã‚Œãªã„ã“ã¨ã¯ç•™æ„å¿…è¦ã€‚
- å¤±æ•—ã—ãŸ Pod ã¯æ®‹ã‚‹
  - ãã®ãŸã‚å¾Œã‹ã‚‰ãƒ­ã‚°ã‚’ç¢ºèªã§ãã‚‹ã€‚

#### OnFailure

- ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã™ã‚‹ã¨ã€åŒã˜ Pod å†…ã§ã‚³ãƒ³ãƒ†ãƒŠãŒå†èµ·å‹•ã•ã‚Œã‚‹ã€‚
- backoffLimit ã«é”ã™ã‚‹ã¾ã§åŒã˜ Pod ã§ã‚¸ãƒ§ãƒ–ãŒå†å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
- ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«é”ã™ã‚‹ã¨ã€å¤±æ•—ã—ãŸ Pod ã¯å‰Šé™¤ã•ã‚Œã‚‹
  - ãã®ãŸã‚å¾Œã‹ã‚‰ãƒ­ã‚°ãŒç¢ºèªã§ããªã„å¯èƒ½æ€§ã‚ã‚Šã€‚

### backoffLimit

ã‚¸ãƒ§ãƒ–å¤±æ•—æ™‚ã«ä½•å›ã¾ã§å†èµ·å‹•ã™ã‚‹ã‹ã‚’è¨­å®šã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ 6 ã§ã€çœç•¥ã™ã‚‹ã¨ã“ã‚ŒãŒé©ç”¨ã•ã‚Œã‚‹
- ãƒªãƒˆãƒ©ã‚¤é–“éš”ã¯æŒ‡æ•°é–¢æ•°çš„ã«å¢—åŠ ã™ã‚‹ ï¼ˆexponential backoffï¼‰

å†å®Ÿè¡Œã•ã›ãŸããªã„å ´åˆã¯ã€restartPolicy ã‚’ Never ã«ã€backoffLimit ã‚’ 0 ã«è¨­å®šã™ã‚‹ã¨è‰¯ã•ãã†ã§ã™ã€‚

# ã•ã„ã”ã«

ç­†è€…ã®ã“ã‚Œã¾ã§ã®çµŒé¨“çš„ã«å®Ÿç¨¼åƒç’°å¢ƒã§CronJobã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã¯æ¯”è¼ƒçš„å°‘ãªã„ã§ã™ã€‚
å…¨ä½“çš„ã«ã‚‚ãã®ã‚ã‚‹ã®ã‹ã€CronJobã«ã¤ã„ã¦æ—¥æœ¬èªã§ã¾ã¨ã¾ã£ã¦ã„ã‚‹è¨˜äº‹ã¯å¤šããªã„æ°—ãŒã—ã¾ã™ã€‚

# å‚è€ƒ

- https://medium.com/devopsturkiye/how-to-set-timezone-for-kubernetes-cronjobs-691d3aaa34ef
- https://zenn.dev/cloud_ace/articles/b5b16938a87770
è‡ªåˆ†ã¨åŒã˜ã‚ˆã†ã«CronJobã‚’ã‚ˆãçŸ¥ã‚‰ãªã„/è§¦ã‚Šå§‹ã‚ã®æ–¹ãªã©ã®
ãŠå½¹ã«ç«‹ã¦ã‚Œã°å¹¸ã„ã§ã™ã€‚

# Environment

ç­†è€…ãŒä»Šå›ä½¿ç”¨ã—ãŸç’°å¢ƒã¯ä»¥ä¸‹ã§ã™ã€‚

- GKE Autopilot ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼
- K8s Version: 1.29.7

# ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ

## schedule ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³

åŸºæœ¬çš„ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ UTC ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã«ãªã‚‹ç’°å¢ƒãŒå¤šã„ã‚ˆã†ã§ã™ã€‚ï¼ˆGKE ã§ã‚‚ãã†ã§ã—ãŸã€‚ï¼‰
ãã®ãŸã‚ã€æ—¥æœ¬æ™‚é–“ã§ã¯ +9 æ™‚é–“ã§ã‚»ãƒƒãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```yaml
spec:
  # ã“ã‚Œã¯,æ—¥æœ¬æ™‚é–“ æ¯æ—¥ 19æ™‚ ã«å®Ÿè¡Œã•ã‚Œã‚‹
  schedule: "0 10 * * *"
  jobTemplate:
    # ...ã‚¸ãƒ§ãƒ–ã®è¨˜è¿°
```

ã—ã‹ã—ãªãŒã‚‰ Ks8 v1.27 ä»¥é™ã§ã¯ã€`.spec.timeZone`ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶å´ã§ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‚ˆã†ã§ã™ã€‚

```yaml
spec:
  timeZone: "Asia/Tokyo"
  schedule: "0 10 * * *"
  jobTemplate:
    # ...ã‚¸ãƒ§ãƒ–ã®è¨˜è¿°
```

> You can specify a time zone for a CronJob by setting .spec.timeZone to the name of a valid time zone. For example, setting .spec.timeZone: "Etc/UTC" instructs Kubernetes to interpret the schedule relative to Coordinated Universal Time.

https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/#time-zones

## ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ãŸã„ã¨ã

Pod ä¸­ã«è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã‚‹ã‚µã‚¤ãƒ‰ã‚«ãƒ¼æ§‹æˆã«ã—ãŸã„ã¨ããŒã‚ã‚Šã¾ã™ã€‚
è‡ªåˆ†ã‚‚ä»Šå›ã€GKE Pod ã‹ã‚‰ CloudSQL ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‹ã£ãŸã®ã§`cloud-sql-proxy`ã‚’ä½¿ã„ãŸã‹ã£ãŸã§ã™ã€‚

ã“ã®æ™‚ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

deployment ã¨åŒã˜ã‚ˆã†ã«ã€`template.spec.containers`ã«ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã¨ä¸¦åˆ—ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’è¨˜è¿°ã™ã‚‹ã¨ã€
ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¸ãƒ§ãƒ–ãŒçµ‚äº†ï¼ˆCompletedï¼‰ã—ã¦ã‚‚ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒèµ·å‹•ã—ç¶šã‘ã‚‹ï¼ˆRunningï¼‰ãŸã‚ã€æ°¸ä¹…ã« CronJob ãŒçµ‚äº†ã—ãªã„çŠ¶æ³ã«é™¥ã‚Šã¾ã™ã€‚
ï¼ˆè‡ªåˆ†ã‚‚ãƒãƒã‚Šã¾ã—ãŸï¼‰

ãã“ã§ã€K8s v1.29 ã‚ˆã‚Š beta ã«æ˜‡æ ¼ã—ãŸ `SidecarContainers`ã¨ã„ã†æ©Ÿèƒ½ãŒä¾¿åˆ©ã§ã™ã€‚

ã“ã®æ©Ÿèƒ½ã§ã¯ã€`initContainers`ã¨ã„ã†ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’æ›¸ãã€`restartPolicy: Always`ã¨ã™ã‚‹ã¨ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠçµ‚äº†å¾Œã‚‚ã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yaml

```

https://kubernetes.io/ja/docs/concepts/workloads/pods/sidecar-containers/

## GKE Autopilot ã®ãƒªã‚½ãƒ¼ã‚¹é…ç½®

resource request / limit ã«ã¤ã„ã¦ã§ã™ã€‚
GKE Autopilot ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ Pod ã«ã¤ã„ã¦ request / limit ã®åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚
é…ç½®å¯èƒ½ãªæœ€å°/æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ cpu/memory ã®æ¯”ç‡ã€ãƒãƒ¼ã‚¹ãƒˆå¯å¦ãªã©ã€ã„ãã¤ã‹ã®åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚

è©³ã—ãã¯ã€ä»¥ä¸‹ã”è¦§ãã ã•ã„ã€‚

https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-resource-requests?hl=ja

2024 å¹´ 8 æœˆç¾åœ¨ã€CronJob ã§ã¯ã€ä»¥ä¸‹ã‚’æ°—ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

- request, limit ã¯ä¸¡æ–¹æ˜è¨˜ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚ï¼ˆDeployment ç­‰ã§ã¯çœç•¥ã—ã¦ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã€‚Autopilot å´ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒä»˜ä¸ã•ã‚Œã‚‹ï¼‰
- request = limit å€¤ã¨ã™ã‚‹å¿…è¦ã‚ã‚Šã€‚ï¼ˆãŠãã‚‰ããƒãƒ¼ã‚¹ãƒˆä¸å¯ï¼‰

kubectl diff ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚apply ã‚‚å¤±æ•—ã—ã¾ã™ã€‚

```
# request, limitæ›¸ã‹ãªã„æ™‚
Violations details: {"[denied by autogke-pod-limit-constraints]":["container '<ã‚³ãƒ³ãƒ†ãƒŠå>' does not have resources/limits defined for all resources which is required in Autopilot clusters."]}

# request = limitå€¤ã¨ã—ãªã‹ã£ãŸæ™‚
Violations details: {"[denied by autogke-pod-limit-constraints]":["container '<ã‚³ãƒ³ãƒ†ãƒŠå>' does not have resource==limits which is required in Autopilot clusters."]}
```

ç‰¹ã«ãƒãƒ¼ã‚¹ãƒˆã§ããªã„ã®ã¯å¾®å¦™ã§ã™ãŒã€Autopilot å´ã®æ”¹å–„ã‚’å¾…ã¡ãŸã„ã§ã™ã€‚



## restartPolicy, backoffLimit

GKE ã«é™ã‚‰ãš CronJob ã‚’æ‰±ã†ä¸Šã§æ°—ã‚’ä»˜ã‘ã‚‹ã¹ãç®‡æ‰€ã§ã™ã€‚
å¤±æ•—æ™‚ã®å†å®Ÿè¡Œã«ã¤ã„ã¦ã¯ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŠŠæ¡ã—ã¦æ¤œè¨ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


### restartPolicy

`Never`ã¾ãŸã¯`OnFailure`ãŒæŒ‡å®šã§ãã¾ã™ã€‚

#### Never

- ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã™ã‚‹ã¨ã€ãã® Pod ã¯å†å®Ÿè¡Œã•ã‚Œãªã„ã€‚
- ãŸã ã—ã€**backoffLimit ã«é”ã™ã‚‹ã¾ã§æ–°ã—ã„ Pod ã§ã‚¸ãƒ§ãƒ–ãŒå†å®Ÿè¡Œã•ã‚Œã‚‹ã€‚ï¼ˆèª¤è§£ã—ã‚„ã™ã„ï¼‰**
  - ãã®ãŸã‚ç•°ãªã‚‹ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚‹ã“ã¨ã‚„çŠ¶æ…‹ã¯ä¿æŒã•ã‚Œãªã„ã“ã¨ã¯ç•™æ„å¿…è¦ã€‚
- å¤±æ•—ã—ãŸ Pod ã¯æ®‹ã‚‹
  - ãã®ãŸã‚å¾Œã‹ã‚‰ãƒ­ã‚°ã‚’ç¢ºèªã§ãã‚‹ã€‚

#### OnFailure

- ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã™ã‚‹ã¨ã€åŒã˜ Pod å†…ã§ã‚³ãƒ³ãƒ†ãƒŠãŒå†èµ·å‹•ã•ã‚Œã‚‹ã€‚
- backoffLimit ã«é”ã™ã‚‹ã¾ã§åŒã˜ Pod ã§ã‚¸ãƒ§ãƒ–ãŒå†å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
- ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«é”ã™ã‚‹ã¨ã€å¤±æ•—ã—ãŸ Pod ã¯å‰Šé™¤ã•ã‚Œã‚‹
  - ãã®ãŸã‚å¾Œã‹ã‚‰ãƒ­ã‚°ãŒç¢ºèªã§ããªã„å¯èƒ½æ€§ã‚ã‚Šã€‚

### backoffLimit

ã‚¸ãƒ§ãƒ–å¤±æ•—æ™‚ã«ä½•å›ã¾ã§å†èµ·å‹•ã™ã‚‹ã‹ã‚’è¨­å®šã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ 6 ã§ã€çœç•¥ã™ã‚‹ã¨ã“ã‚ŒãŒé©ç”¨ã•ã‚Œã‚‹
- ãƒªãƒˆãƒ©ã‚¤é–“éš”ã¯æŒ‡æ•°é–¢æ•°çš„ã«å¢—åŠ ã™ã‚‹ ï¼ˆexponential backoffï¼‰

å†å®Ÿè¡Œã•ã›ãŸããªã„å ´åˆã¯ã€restartPolicy ã‚’ Never ã«ã€backoffLimit ã‚’ 0 ã«è¨­å®šã™ã‚‹ã¨è‰¯ã•ãã†ã§ã™ã€‚

# ã•ã„ã”ã«

ç­†è€…ã®ã“ã‚Œã¾ã§ã®çµŒé¨“çš„ã«å®Ÿç¨¼åƒç’°å¢ƒã§CronJobã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã¯æ¯”è¼ƒçš„å°‘ãªã„ã§ã™ã€‚
å…¨ä½“çš„ã«ã‚‚ãã®ã‚ã‚‹ã®ã‹ã€CronJobã«ã¤ã„ã¦æ—¥æœ¬èªã§ã¾ã¨ã¾ã£ã¦ã„ã‚‹è¨˜äº‹ã¯å¤šããªã„æ°—ãŒã—ã¾ã™ã€‚

# å‚è€ƒ

- https://medium.com/devopsturkiye/how-to-set-timezone-for-kubernetes-cronjobs-691d3aaa34ef
- https://zenn.dev/cloud_ace/articles/b5b16938a87770
